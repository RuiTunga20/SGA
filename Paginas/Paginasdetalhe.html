<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Documento - {{ documento.numero_protocolo }}</title>
<style>
    :root {
        --primary-orange: red; --text-grey: #5a5a5a; --primary-red: #c8102e;
        --accent-gold: #daa520; --bg-primary: #f4f4f4; --bg-secondary: #ffffff;
        --border: #cccccc; --shadow: 0 1px 3px rgba(0, 0, 0, 0.07);
        --success-green: #16a34a; --secondary-grey: #6b7280;
    }
    body { font-family: Arial, Helvetica, sans-serif; background: var(--bg-primary); color: #333; line-height: 1.6; }
    .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
    .content-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 3px; padding: 2rem; box-shadow: var(--shadow); margin-top: 2rem; }
    .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem; color: var(--primary-red); font-size: 1.25rem; border-bottom: 1px solid #eee; padding-bottom: 1rem; }
    .page-header h1 { font-size: 1.5rem; margin: 0; }
    .page-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; }
    .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem; }
    .detail-item .label { font-weight: bold; font-size: 0.9rem; }
    .status-badge { padding: 0.2rem 0.6rem; border-radius: 3px; color: white; font-size: 0.8rem; font-weight: bold; }
    .status-aprovado { background-color: var(--success-green); }
    .status-reprovado { background-color: var(--primary-red); }
    .status-arquivado { background-color: var(--secondary-grey); }
    .status-recebido, .status-encaminhado { background-color: #3b82f6; }
    .status-em_analise { background-color: #f59e0b; }
    .timeline { list-style: none; padding: 0; }
    .timeline-item { padding-bottom: 1.5rem; border-left: 2px solid var(--border); position: relative; padding-left: 1.5rem; }
    .timeline-item::before { content: ''; position: absolute; left: -6px; top: 5px; width: 10px; height: 10px; border-radius: 50%; background: var(--primary-red); }
    
    .despacho-text {
        background-color: #f8f9fa;
        border-left: 3px solid var(--accent-gold);
        padding: 0.75rem 1rem;
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: #333;
        border-radius: 0 3px 3px 0;
        white-space: pre-wrap;
    }

    .action-form .form-group { margin-bottom: 1rem; }
    .form-label { font-weight: bold; font-size: 0.9rem; display: block; margin-bottom: 0.5rem; }
    .form-select, .form-textarea { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: 3px; font-size: 1rem; font-family: Arial; }
    .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent-gold); box-shadow: 0 0 0 2px rgba(218, 165, 32, 0.2); }
    .btn { padding: 0.75rem 1.5rem; border-radius: 3px; border: 1px solid transparent; font-weight: bold; cursor: pointer; text-decoration: none; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 0.5rem; }
    .btn-primary { background: var(--primary-red); color: white; }
    .btn-primary:hover { background: #a20c24; }
    .btn-success { background-color: var(--success-green); color: white; }
    .btn-success:hover { background-color: #15803d; }
    .btn-danger { background-color: var(--primary-red); color: white; }
    .btn-secondary { background: #e9e9e9; color: #333; border: 1px solid var(--border); }
    .btn-secondary:hover { background: #dcdcdc; }
    .btn-archive { background-color: var(--secondary-grey); color: white; }
    .btn-archive:hover { background-color: #4b5563; }
    .final-actions { display: flex; gap: 1rem; flex-wrap: wrap; }
    .form-errors { color: var(--primary-red); font-size: 0.85rem; margin-top: 0.25rem; }

    /* NOVO: Estilo para campos de destino lado a lado */
    .destino-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .form-help { font-size: 0.8rem; color: var(--text-grey); margin-top: 0.25rem; }
    .alert-info { background: #e7f3ff; border: 1px solid #b3d9ff; border-left: 4px solid #0066cc; padding: 1rem; border-radius: 3px; margin-bottom: 1rem; font-size: 0.85rem; }

    @media (max-width: 992px) {
        .page-grid { grid-template-columns: 1fr; }
        .details-grid { grid-template-columns: 1fr; }
        .destino-row { grid-template-columns: 1fr; }
    }
</style>
</head>
<body>
    {% include "menu.html" %}
    <div class="container">
        <div class="content-card">
            <div class="page-header">
                <div><h1>{{ documento.titulo }}</h1></div>
            </div>
            <div class="page-grid">
                <div class="main-column">
                    <h4>Detalhes do Documento</h4>
                    <hr style="margin: 1rem 0;">
                    <div class="details-grid">
                        <div class="detail-item"><div class="label">Protocolo</div><div class="value">{{ documento.numero_protocolo }}</div></div>
                        <div class="detail-item"><div class="label">Tipo de Documento</div><div class="value">{{ documento.tipo_documento.nome }}</div></div>
                        <div class="detail-item"><div class="label">Origem</div><div class="value">{{ documento.get_origem_display }}</div></div>
                        <div class="detail-item"><div class="label">Prioridade</div><div class="value">{{ documento.get_prioridade_display }}</div></div>
                        <div class="detail-item"><div class="label">Estado</div><div class="value"><span class="status-badge status-{{ documento.status }}">{{ documento.get_status_display }}</span></div></div>
                        <div class="detail-item"><div class="label">Departamento Atual</div><div class="value">{{ documento.departamento_atual.nome }}</div></div>
                        <div class="detail-item"><div class="label">Data</div><div class="value">{{ documento.data_criacao|date:"d/m/Y H:i" }}</div></div>

                        {% if documento.arquivo %}
                        <div class="detail-item">
                            <div class="label">Ficheiro Anexo</div>
                            <div class="value"><a href="{{ documento.arquivo.url }}" target="_blank" class="btn btn-secondary">üìé Ver Anexo</a></div>
                        </div>
                        {% endif %}

                    </div>
                     <div class="detail-item">
                          <div class="label">Pareceres</div>
                     {% for observacoes in observacoes %}
                         {% if observacoes.observacoes %}

                      <div class="value">{{ observacoes.observacoes }} <br> {{ observacoes.usuario }} -

                        {% if observacoes.usuario.departamento %}
                          {{ observacoes.usuario.departamento }}
                          {% else %}
                           {{ observacoes.usuario.seccao }}

                      {% endif %}


                      </div>
                                                     <hr style="margin: 1rem 0;">
                     {% endif %}
                            {% endfor %}

                     </div>


                    {% if pode_encaminhar %}
                        <div class="action-form">
                            <hr style="margin: 2rem 0;">
                            <h4>A√ß√µes do Documento</h4>

                            <form method="post" style="margin-top: 1rem;">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="encaminhar">
                                {{ encaminhar_form.tipo_movimentacao.as_hidden }}
                                <h5>Encaminhar Documento</h5>

                                <!-- ALERTA INFORMATIVO -->
                                <div class="alert-info">
                                    <strong>‚ÑπÔ∏è Escolha o destino:</strong>
                                    Selecione <strong>APENAS UM</strong> destino (departamento <strong>OU</strong> sec√ß√£o espec√≠fica).
                                </div>

                                <!-- CAMPOS DE DESTINO LADO A LADO -->
                                <div class="destino-row">
                                    <div class="form-group">
                                        <label for="{{ encaminhar_form.departamento_destino.id_for_label }}" class="form-label">
                                            Departamento:
                                        </label>
                                        {{ encaminhar_form.departamento_destino }}
                                        <div class="form-help">Todo o departamento</div>
                                        <div class="form-errors">{{ encaminhar_form.departamento_destino.errors }}</div>
                                    </div>

                                    <!-- NOVO: Campo de Sec√ß√£o -->
                                    <div class="form-group">
                                        <label for="{{ encaminhar_form.seccao_destino.id_for_label }}" class="form-label">
                                            Sec√ß√£o:
                                            <span style="color: #16a34a; font-weight: bold;">(Recomendado)</span>
                                        </label>
                                        {{ encaminhar_form.seccao_destino }}
                                        <div class="form-help">Apenas a sec√ß√£o</div>
                                        <div class="form-errors">{{ encaminhar_form.seccao_destino.errors }}</div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="{{ encaminhar_form.observacoes.id_for_label }}" class="form-label">Pareceres</label>
                                    {{ encaminhar_form.observacoes }}
                                    <div class="form-errors">{{ encaminhar_form.observacoes.errors }}</div>
                                </div>
                                <button type="submit" class="btn btn-primary">üì® Encaminhar</button>
                            </form>
                            {% if e_administrador %}

                            <hr style="margin: 2rem 0;">

                            <form method="post" style="margin-top: 1rem;">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="despacho">
                                <h5>Adicionar Despacho</h5>
                                <div class="form-group">
                                    <label for="{{ despacho_form.despacho.id_for_label }}" class="form-label">Despacho:</label>
                                    {{ despacho_form.despacho }}
                                    <div class="form-errors">{{ despacho_form.despacho.errors }}</div>
                                </div>
                                <div class="form-group">
                                    <label for="{{ despacho_form.novo_status.id_for_label }}" class="form-label">Mudar Status para (Opcional):</label>
                                    {{ despacho_form.novo_status }}
                                    <div class="form-errors">{{ despacho_form.novo_status.errors }}</div>
                                </div>
                                <button type="submit" class="btn btn-primary">üìã Adicionar Despacho</button>
                            </form>

                            <!-- A√á√ïES FINAIS: APENAS PARA ADMINISTRADORES -->
                            <hr style="margin: 2rem 0;">
                            <h5>A√ß√µes Finais (Administrador)</h5>
                            <p style="font-size: 0.85rem; color: var(--text-grey); margin-bottom: 1rem;">
                                ‚ö†Ô∏è Estas a√ß√µes s√£o irrevers√≠veis e apenas administradores podem execut√°-las.
                            </p>
                            <div class="final-actions">
                                <form method="post">
                                    <button type="submit" class="btn btn-success">‚úÖ Aprovar</button>
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="aprovado">
                                </form>
                                <form method="post">
                                    <button type="submit" class="btn btn-danger">‚ùå Reprovar</button>
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="reprovado">
                                </form>
                                <a href="{% url 'registrar_armazenamento' documento.id %}" class="btn btn-secondary">üì¶ Registrar Armazenamento</a>
                                <form method="post">
                                    <button type="submit" class="btn btn-archive">üóÑÔ∏è Arquivar</button>
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="arquivado">
                                </form>
                            </div>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
                <div class="sidebar-column">
                    {% if movimentacoes_pendentes %}
                        <div style="background-color: #fffbe6; padding: 1rem; border-radius: 3px; border: 1px solid #fef08a; margin-bottom: 2rem;">
                            <h5 style="margin-top:0;">‚ùóÔ∏è A√ß√£o Pendente</h5>
                            <form method="post">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="confirmar_recebimento">
                                <input type="hidden" name="movimentacao_id" value="{{ movimentacoes_pendentes.0.id }}">
                                <button type="submit" class="btn btn-success" style="width: 100%;">‚úÖ Confirmar Recebimento</button>
                            </form>
                        </div>
                    {% endif %}
                    <h4>Hist√≥rico</h4>
                    <hr style="margin: 1rem 0;">
                    <ul class="timeline">
                        {% for mov in movimentacoes %}
                        <li class="timeline-item">
                            <div class="time">{{ mov.data_movimentacao|date:"d/m/Y H:i" }}</div>
                            <div class="actor">{{ mov.usuario.username }}</div>
                            <div class="description">
                                <strong>{{ mov.get_tipo_movimentacao_display }}</strong>
                                {% if mov.seccao_destino %}
                                    para sec√ß√£o <strong>{{ mov.seccao_destino.nome }}</strong>
                                {% elif mov.departamento_destino %}
                                    para <strong>{{ mov.departamento_destino.nome }}</strong>
                                {% endif %}.
                            </div>

                            {% if mov.despacho %}
                            <div class="despacho-text">
                                {{ mov.despacho|linebreaksbr }}
                            </div>
                            {% endif %}
                        </li>
                        {% empty %}
                        <li>Nenhuma movimenta√ß√£o.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <!-- Select2 CSS e JS para autocomplete/filtro nos selects -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <style>
        /* Estilos customizados para Select2 */
        .select2-container--default .select2-selection--single {
            height: 42px;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 3px;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 24px;
            color: #333;
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 40px;
        }
        .select2-dropdown {
            border: 1px solid var(--border);
            border-radius: 3px;
        }
        .select2-container--default .select2-search--dropdown .select2-search__field {
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 0.5rem;
        }
        .select2-container--default .select2-results__option--highlighted[aria-selected] {
            background-color: var(--accent-gold);
        }
        .select2-container {
            width: 100% !important;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.action-form select').forEach(el => el.classList.add('form-select'));
            document.querySelectorAll('.action-form textarea').forEach(el => el.classList.add('form-textarea'));

            // Script para desabilitar campos mutuamente
            const deptSelect = document.querySelector('select[name="departamento_destino"]');
            const secSelect = document.querySelector('select[name="seccao_destino"]');

            if (deptSelect && secSelect) {
                // Quando seleciona departamento, limpa e desabilita sec√ß√£o
                deptSelect.addEventListener('change', function() {
                    if (this.value) {
                        secSelect.value = '';
                        secSelect.disabled = true;
                        secSelect.style.opacity = '0.5';
                        secSelect.parentElement.querySelector('.form-help').textContent = '‚ö†Ô∏è Desabilitado';
                        // Atualizar Select2
                        $(secSelect).val('').trigger('change');
                    } else {
                        secSelect.disabled = false;
                        secSelect.style.opacity = '1';
                        secSelect.parentElement.querySelector('.form-help').textContent = 'Apenas a sec√ß√£o';
                    }
                });

                // Quando seleciona sec√ß√£o, limpa e desabilita departamento
                secSelect.addEventListener('change', function() {
                    if (this.value) {
                        deptSelect.value = '';
                        deptSelect.disabled = true;
                        deptSelect.style.opacity = '0.5';
                        deptSelect.parentElement.querySelector('.form-help').textContent = '‚ö†Ô∏è Desabilitado';
                        // Atualizar Select2
                        $(deptSelect).val('').trigger('change');
                    } else {
                        deptSelect.disabled = false;
                        deptSelect.style.opacity = '1';
                        deptSelect.parentElement.querySelector('.form-help').textContent = 'Todo o departamento';
                    }
                });

                // Reabilitar antes de submeter
                document.querySelectorAll('form').forEach(function(form) {
                    form.addEventListener('submit', function(e) {
                        if (deptSelect) deptSelect.disabled = false;
                        if (secSelect) secSelect.disabled = false;
                    });
                });
            }
        });

        // Ativar Select2 ap√≥s o DOM estar pronto
        $(document).ready(function() {
            $('select').select2({
                placeholder: 'Pesquisar...',
                allowClear: true,
                language: {
                    noResults: function() {
                        return "Nenhum resultado encontrado";
                    },
                    searching: function() {
                        return "Pesquisando...";
                    }
                }
            });
        });
    </script>
</body>
</html>